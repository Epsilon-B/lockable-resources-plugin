<!--
* * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * *
* Copyright (c) 2013, 6WIND S.A. All rights reserved.                 *
*                                                                     *
* This file is part of the Jenkins Lockable Resources Plugin and is   *
* published under the MIT license.                                    *
*                                                                     *
* See the "LICENSE.txt" file for more information.                    *
* * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * *
-->
<?jelly escape-by-default='true'?>
<j:jelly xmlns:j="jelly:core" xmlns:st="jelly:stapler" xmlns:d="jelly:define"
         xmlns:l="/lib/layout" xmlns:t="/lib/hudson" xmlns:f="/lib/form"
         xmlns:i="jelly:fmt" xmlns:p="/lib/hudson/project">

    <l:layout title="${it.displayName}">
        <l:main-panel>
            <h1>${%Lockable Resources}</h1>
            <table class="pane" style="width: 80%;">
                <tbody>
                    <tr>
                        <td class="pane-header">Resource</td>
                        <td class="pane-header">Status</td>
                        <td class="pane-header">Capabilities</td>
                        <td class="pane-header">Action</td>
                    </tr>
                    <j:forEach var="resource" items="${it.resources}" indexVar="i">
                        <script>
                            function unlock_resource_${i}() {
                            if(!confirm("Are you sure ? A conflict with another job may occures.")) {return}
                            window.location.assign("unlock?resource=${resource.name}");
                            }
                            function reserve_resource_${i}() {
                            window.location.assign("reserve?resource=${resource.name}");
                            }
                            function unreserve_resource_${i}() {
                            if(!confirm("Are you sure ? Anyone will be able to use this resource (even queued jobs).")) {return}
                            window.location.assign("unreserve?resource=${resource.name}");
                            }
                            function reset_resource_${i}() {
                            if(!confirm("Are you sure ? A conflict with another job may occures.")) {return}
                            window.location.assign("reset?resource=${resource.name}");
                            }
                            function reserveFor_resource_${i}() {
                            var forUser = prompt("Id or full name of the user:", "${it.UserId}");
                            if(forUser == null) {return}
                            var hours = prompt("Duration of the reservation (max = ${it.maxReservationHours} hours):", "${it.defaultReservationHours}");
                            if(hours == null) {return}
                            window.location.assign("reserveFor?resource=${resource.name}&amp;forUser=" + forUser + "&amp;hours=" + hours);
                            }
                            function unreserveFor_resource_${i}() {
                            if(!confirm("Are you sure ? You will lost reservation for this resource.")) {return}
                            window.location.assign("unreserveFor?resource=${resource.name}");
                            }
                        </script>
                        <tr>
                            <td class="pane">
                                <strong>${resource.name}</strong>
                                <br/>
                                <em>${resource.description}</em>
                            </td>
                            <td class="pane">
                                <!-- Manage first the lock status (free/queued/locked) -->
                                <j:choose>
                                    <j:when test="${resource.locked}">
                                        <div style="color: blue;">
                                            <strong>LOCKED</strong> by
                                            <a href="${rootURL}/${resource.build.url}">
                                                ${resource.build.fullDisplayName}
                                            </a>
                                        </div>
                                    </j:when>
                                    <j:when test="${resource.queued}">
                                        <div style="color: red;">
                                            QUEUED by "${resource.queueItemProject} ${resource.queueItemId}"
                                        </div>
                                    </j:when>
                                    <j:when test="${!resource.isReserved(it.UserId)}">
                                        <div style="color: green;">
                                            <strong>AVAILABLE</strong>
                                        </div>
                                    </j:when>
                                    <j:otherwise>
                                        <div style="color: black;">---</div>
                                    </j:otherwise>
                                </j:choose>
                                <!-- Then, manage online/offline and reservation -->
                                <j:choose>
                                    <j:when test="${resource.reservedFor != null}">
                                        <div style="color: #800080;">
                                            <strong>RESERVED</strong> by ${resource.reservedByName} for <strong>${resource.reservedForName}</strong> until <strong>${resource.reservedUntilString}</strong>
                                        </div>
                                    </j:when>
                                    <j:when test="${resource.reservedBy != null}">
                                        <div style="color: grey;">
                                            <strong>OFFLINE</strong> by <strong>${resource.reservedByName}</strong>
                                        </div>
                                    </j:when>
                                </j:choose>
                            </td>
                            <td class="pane">${resource.labels}</td>
                            <td class="pane">
                                <!-- Manage first the lock status (free/queued/locked) -->
                                <j:choose>
                                    <j:when test="${resource.locked}">
                                        <j:if test="${app.hasPermission(it.UNLOCK)}">
                                            <button onClick="unlock_resource_${i}();">Unlock</button>
                                        </j:if>
                                    </j:when>
                                    <j:when test="${resource.queued}">
                                        <j:if test="${app.hasPermission(it.UNLOCK)}">
                                            <button onClick="reset_resource_${i}();">Reset</button>
                                        </j:if>
                                    </j:when>
                                </j:choose>
                                <!-- Then, manage online/offline and reservations -->
                                <j:choose>
                                    <j:when test="${resource.reservedFor != null}">
                                        <j:if test="${app.hasPermission(it.RESERVE) and (it.userId == resource.reservedBy)}">
                                            <button onClick="reserveFor_resource_${i}();">Change reservation</button>
                                        </j:if>
                                        <j:if test="${app.hasPermission(it.OFFLINE)}">
                                            <button onClick="reserve_resource_${i}();">Set offline</button>
                                        </j:if>
                                        <j:if test="${app.hasPermission(it.UNLOCK) or (app.hasPermission(it.RESERVE) and (it.userId == resource.reservedBy)) or (it.userId == resource.reservedFor)}">
                                            <button onClick="unreserveFor_resource_${i}();">UnReserve</button>
                                        </j:if>
                                    </j:when>
                                    <j:when test="${resource.reservedBy != null}">
                                        <j:if test="${app.hasPermission(it.OFFLINE) and app.hasPermission(it.RESERVE)}">
                                            <button onClick="reserveFor_resource_${i}();">Online + reservation</button>
                                        </j:if>
                                        <j:if test="${app.hasPermission(it.UNLOCK) or app.hasPermission(it.OFFLINE)}">
                                            <button onClick="unreserve_resource_${i}();">Set online</button>
                                        </j:if>
                                    </j:when>
                                    <j:otherwise>
                                        <j:if test="${app.hasPermission(it.RESERVE)}">
                                            <button onClick="reserveFor_resource_${i}();">Reserve</button>
                                        </j:if>
                                        <j:if test="${app.hasPermission(it.OFFLINE)}">
                                            <button onClick="reserve_resource_${i}();">Set offline</button>
                                        </j:if>
                                    </j:otherwise>
                                </j:choose>
                            </td>
                        </tr>
                    </j:forEach>
                </tbody>
            </table>
            <j:if test="${it.getNumberOfAllLabels() != 0}">
                <h3>Capabilities</h3>
                <table class="pane" style="width: 50%;">
                    <tbody>
                        <tr>
                            <td class="pane-header">Capability</td>
                            <td class="pane-header">Free resources</td>
                        </tr>
                        <j:forEach var="label" items="${it.getAllLabels()}">
                            <tr>
                                <j:choose>
                                    <j:when test="${it.getFreeResourceAmount(label) == 0}">
                                        <td class="pane" style="color: red;">${label}</td>
                                        <td class="pane" style="color: red;">0</td>
                                    </j:when>
                                    <j:when test="${it.getFreeResourceAmount(label) == 1}">
                                        <td class="pane" style="color: darkorange;">${label}</td>
                                        <td class="pane" style="color: darkorange;">1</td>
                                    </j:when>
                                    <j:otherwise>
                                        <td class="pane" style="color: green;">${label}</td>
                                        <td class="pane" style="color: green;">${it.getFreeResourceAmount(label)}</td>
                                    </j:otherwise>
                                </j:choose>
                            </tr>
                        </j:forEach>
                    </tbody>
                </table>
            </j:if>

        </l:main-panel>
    </l:layout>
</j:jelly>
